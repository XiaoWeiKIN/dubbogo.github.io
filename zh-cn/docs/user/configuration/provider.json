{
  "filename": "provider.md",
  "__html": "<h1>service providers</h1>\n<h2>第一步：编写提供端的服务</h2>\n<ol>\n<li>\n<p>编写需要被编码的结构体，由于使用 <code>Hessian2</code> 作为编码协议，<code>User</code> 需要实现 <code>JavaClassName</code> 方法，它的返回值在dubbo中对应User类的类名。</p>\n<pre><code class=\"language-go\"><span class=\"hljs-keyword\">type</span> User <span class=\"hljs-keyword\">struct</span> {\n\tId   <span class=\"hljs-keyword\">string</span>\n\tName <span class=\"hljs-keyword\">string</span>\n\tAge  <span class=\"hljs-keyword\">int32</span>\n\tTime time.Time\n}\n\n<span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(u User)</span> <span class=\"hljs-title\">JavaClassName</span><span class=\"hljs-params\">()</span> <span class=\"hljs-title\">string</span></span> {\n\t<span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">\"org.apache.dubbo.User\"</span>\n}\n</code></pre>\n</li>\n<li>\n<p>编写业务逻辑，<code>UserProvider</code> 相当于dubbo中的一个服务实现。需要实现 <code>Reference</code> 方法，返回值是这个服务的唯一标识，对应dubbo的 <code>beans</code> 和 <code>path</code> 字段。</p>\n<pre><code class=\"language-go\"><span class=\"hljs-keyword\">type</span> UserProvider <span class=\"hljs-keyword\">struct</span> {\n}\n\n<span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(u *UserProvider)</span> <span class=\"hljs-title\">GetUser</span><span class=\"hljs-params\">(ctx context.Context, req []<span class=\"hljs-keyword\">interface</span>{})</span> <span class=\"hljs-params\">(*User, error)</span></span> {\n\t<span class=\"hljs-built_in\">println</span>(<span class=\"hljs-string\">\"req:%#v\"</span>, req)\n\trsp := User{<span class=\"hljs-string\">\"A001\"</span>, <span class=\"hljs-string\">\"hellowworld\"</span>, <span class=\"hljs-number\">18</span>, time.Now()}\n\t<span class=\"hljs-built_in\">println</span>(<span class=\"hljs-string\">\"rsp:%#v\"</span>, rsp)\n\t<span class=\"hljs-keyword\">return</span> &amp;rsp, <span class=\"hljs-literal\">nil</span>\n}\n\n<span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(u *UserProvider)</span> <span class=\"hljs-title\">Reference</span><span class=\"hljs-params\">()</span> <span class=\"hljs-title\">string</span></span> {\n\t<span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">\"UserProvider\"</span>\n}\n</code></pre>\n</li>\n<li>\n<p>注册服务和对象</p>\n<pre><code class=\"language-go\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">init</span><span class=\"hljs-params\">()</span></span> {\n\tconfig.SetProviderService(<span class=\"hljs-built_in\">new</span>(UserProvider))\n\t<span class=\"hljs-comment\">// ------for hessian2------</span>\n\thessian.RegisterPOJO(&amp;User{})\n}\n</code></pre>\n</li>\n</ol>\n<h2>第二步：编写主程序</h2>\n<ol>\n<li>\n<p>引入必需的dubbo-go包</p>\n<pre><code class=\"language-go\"><span class=\"hljs-keyword\">import</span> (\n\thessian <span class=\"hljs-string\">\"github.com/apache/dubbo-go-hessian2\"</span>\n\t_ <span class=\"hljs-string\">\"github.com/apache/dubbo-go/cluster/cluster_impl\"</span>\n\t_ <span class=\"hljs-string\">\"github.com/apache/dubbo-go/cluster/loadbalance\"</span>\n\t<span class=\"hljs-string\">\"github.com/apache/dubbo-go/common/logger\"</span>\n\t_ <span class=\"hljs-string\">\"github.com/apache/dubbo-go/common/proxy/proxy_factory\"</span>\n\t<span class=\"hljs-string\">\"github.com/apache/dubbo-go/config\"</span>\n\t_ <span class=\"hljs-string\">\"github.com/apache/dubbo-go/filter/filter_impl\"</span>\n\t_ <span class=\"hljs-string\">\"github.com/apache/dubbo-go/protocol/dubbo\"</span>\n\t_ <span class=\"hljs-string\">\"github.com/apache/dubbo-go/registry/protocol\"</span>\n\t_ <span class=\"hljs-string\">\"github.com/apache/dubbo-go/registry/zookeeper\"</span>\n)\n</code></pre>\n</li>\n<li>\n<p>main 函数</p>\n<pre><code class=\"language-go\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">()</span></span> {\n  config.Load()\n}\n</code></pre>\n</li>\n</ol>\n<h2>第三步：编写配置文件并配置环境变量</h2>\n<ol>\n<li>\n<p>设置配置文件 log.yml, server.yml</p>\n<ul>\n<li><strong>log.yml</strong></li>\n</ul>\n<pre><code class=\"language-yml\"><span class=\"hljs-attr\">level:</span> <span class=\"hljs-string\">\"error\"</span>\n<span class=\"hljs-attr\">development:</span> <span class=\"hljs-literal\">true</span>\n<span class=\"hljs-attr\">disableCaller:</span> <span class=\"hljs-literal\">false</span>\n<span class=\"hljs-attr\">disableStacktrace:</span> <span class=\"hljs-literal\">false</span>\n<span class=\"hljs-attr\">sampling:</span>\n<span class=\"hljs-attr\">encoding:</span> <span class=\"hljs-string\">\"console\"</span>\n\n<span class=\"hljs-comment\"># encoder</span>\n<span class=\"hljs-attr\">encoderConfig:</span>\n  <span class=\"hljs-attr\">messageKey:</span> <span class=\"hljs-string\">\"message\"</span>\n  <span class=\"hljs-attr\">levelKey:</span> <span class=\"hljs-string\">\"level\"</span>\n  <span class=\"hljs-attr\">timeKey:</span> <span class=\"hljs-string\">\"time\"</span>\n  <span class=\"hljs-attr\">nameKey:</span> <span class=\"hljs-string\">\"logger\"</span>\n  <span class=\"hljs-attr\">callerKey:</span> <span class=\"hljs-string\">\"caller\"</span>\n  <span class=\"hljs-attr\">stacktraceKey:</span> <span class=\"hljs-string\">\"stacktrace\"</span>\n  <span class=\"hljs-attr\">lineEnding:</span> <span class=\"hljs-string\">\"\"</span>\n  <span class=\"hljs-attr\">levelEncoder:</span> <span class=\"hljs-string\">\"capital\"</span>\n  <span class=\"hljs-attr\">timeEncoder:</span> <span class=\"hljs-string\">\"iso8601\"</span>\n  <span class=\"hljs-attr\">durationEncoder:</span> <span class=\"hljs-string\">\"seconds\"</span>\n  <span class=\"hljs-attr\">callerEncoder:</span> <span class=\"hljs-string\">\"short\"</span>\n  <span class=\"hljs-attr\">nameEncoder:</span> <span class=\"hljs-string\">\"\"</span>\n\n<span class=\"hljs-attr\">outputPaths:</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">\"stderr\"</span>\n<span class=\"hljs-attr\">errorOutputPaths:</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">\"stderr\"</span>\n<span class=\"hljs-attr\">initialFields:</span>\n</code></pre>\n<ul>\n<li>server.yml</li>\n</ul>\n<pre><code class=\"language-yml\"><span class=\"hljs-comment\"># dubbo server yaml configure file</span>\n\n<span class=\"hljs-comment\"># application config</span>\n<span class=\"hljs-attr\">application:</span>\n  <span class=\"hljs-attr\">organization:</span> <span class=\"hljs-string\">\"dubbo.io\"</span>\n  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">\"UserInfoServer\"</span>\n  <span class=\"hljs-attr\">module:</span> <span class=\"hljs-string\">\"dubbo-go user-info server\"</span>\n  <span class=\"hljs-attr\">version:</span> <span class=\"hljs-string\">\"0.0.1\"</span>\n  <span class=\"hljs-attr\">environment:</span> <span class=\"hljs-string\">\"dev\"</span>\n\n<span class=\"hljs-comment\"># registry config</span>\n<span class=\"hljs-attr\">registries:</span>\n  <span class=\"hljs-attr\">\"demoZk\":</span>\n    <span class=\"hljs-attr\">protocol:</span> <span class=\"hljs-string\">\"zookeeper\"</span>\n    <span class=\"hljs-attr\">timeout:</span> <span class=\"hljs-string\">\"3s\"</span>\n    <span class=\"hljs-attr\">address:</span> <span class=\"hljs-string\">\"127.0.0.1:2181\"</span>\n\n<span class=\"hljs-comment\"># service config</span>\n<span class=\"hljs-attr\">services:</span>\n  <span class=\"hljs-attr\">\"UserProvider\":</span>\n    <span class=\"hljs-attr\">registry:</span> <span class=\"hljs-string\">\"demoZk\"</span>\n    <span class=\"hljs-attr\">protocol:</span> <span class=\"hljs-string\">\"dubbo\"</span>\n    <span class=\"hljs-attr\">interface:</span> <span class=\"hljs-string\">\"org.apache.dubbo.UserProvider\"</span>\n    <span class=\"hljs-attr\">loadbalance:</span> <span class=\"hljs-string\">\"random\"</span>\n    <span class=\"hljs-attr\">warmup:</span> <span class=\"hljs-string\">\"100\"</span>\n    <span class=\"hljs-attr\">cluster:</span> <span class=\"hljs-string\">\"failover\"</span>\n    <span class=\"hljs-attr\">methods:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">\"GetUser\"</span>\n        <span class=\"hljs-attr\">retries:</span> <span class=\"hljs-number\">1</span>\n        <span class=\"hljs-attr\">loadbalance:</span> <span class=\"hljs-string\">\"random\"</span>\n\n<span class=\"hljs-comment\"># protocol config</span>\n<span class=\"hljs-attr\">protocols:</span>\n  <span class=\"hljs-attr\">\"dubbo\":</span>\n    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">\"dubbo\"</span>\n    <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">20000</span>\n\n<span class=\"hljs-attr\">protocol_conf:</span>\n  <span class=\"hljs-attr\">dubbo:</span>\n    <span class=\"hljs-attr\">session_number:</span> <span class=\"hljs-number\">700</span>\n    <span class=\"hljs-attr\">session_timeout:</span> <span class=\"hljs-string\">\"180s\"</span>\n    <span class=\"hljs-attr\">getty_session_param:</span>\n      <span class=\"hljs-attr\">compress_encoding:</span> <span class=\"hljs-literal\">false</span>\n      <span class=\"hljs-attr\">tcp_no_delay:</span> <span class=\"hljs-literal\">true</span>\n      <span class=\"hljs-attr\">tcp_keep_alive:</span> <span class=\"hljs-literal\">true</span>\n      <span class=\"hljs-attr\">keep_alive_period:</span> <span class=\"hljs-string\">\"120s\"</span>\n      <span class=\"hljs-attr\">tcp_r_buf_size:</span> <span class=\"hljs-number\">262144</span>\n      <span class=\"hljs-attr\">tcp_w_buf_size:</span> <span class=\"hljs-number\">65536</span>\n      <span class=\"hljs-attr\">pkg_rq_size:</span> <span class=\"hljs-number\">1024</span>\n      <span class=\"hljs-attr\">pkg_wq_size:</span> <span class=\"hljs-number\">512</span>\n      <span class=\"hljs-attr\">tcp_read_timeout:</span> <span class=\"hljs-string\">\"1s\"</span>\n      <span class=\"hljs-attr\">tcp_write_timeout:</span> <span class=\"hljs-string\">\"5s\"</span>\n      <span class=\"hljs-attr\">wait_timeout:</span> <span class=\"hljs-string\">\"1s\"</span>\n      <span class=\"hljs-attr\">max_msg_len:</span> <span class=\"hljs-number\">1024000</span>\n      <span class=\"hljs-attr\">session_name:</span> <span class=\"hljs-string\">\"server\"</span>\n</code></pre>\n<p>主要编辑以下部分：</p>\n<ul>\n<li><code>registries</code> 结点下需要配置zk的数量和地址</li>\n<li><code>services</code> 结点下配置服务的具体信息，需要配置 <code>interface</code> 配置，修改为对应服务的接口名，服务的key对应第一步中 <code>Provider</code> 的 <code>Reference</code> 返回值</li>\n</ul>\n</li>\n<li>\n<p>把上面的两个配置文件分别配置为环境变量</p>\n<pre><code class=\"language-shell\">export CONF_PROVIDER_FILE_PATH=\"xxx\"\nexport APP_LOG_CONF_FILE=\"xxx\"\n</code></pre>\n</li>\n</ol>\n<p>本文章源码详情见git：<a href=\"https://github.com/apache/dubbo-go-samples/tree/1.5/helloworld/go-server\">https://github.com/apache/dubbo-go-samples/tree/1.5/helloworld/go-server</a></p>\n",
  "link": "/zh-cn/docs/user/configuration/provider.html",
  "meta": {
    "title": "service providers",
    "keywords": "提供端，server provider",
    "description": "提示用户配置服务提供"
  }
}